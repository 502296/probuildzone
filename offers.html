<!doctype html>

<html lang="en">

<head>

<meta charset="utf-8"/>

<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>ProBuildZone — Job Offers</title>

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>

  :root{--ink:#0F2A43;--bg:#f6f7fb;--card:#fff;--accent:#0b7ef4;--ok:#0a7f4f;}

  *{box-sizing:border-box}

  body{font-family:Inter,system-ui,-apple-system,Segoe UI,sans-serif;margin:0;background:var(--bg);color:var(--ink);padding:24px}

  .wrap{max-width:640px;margin:24px auto;background:var(--card);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:22px}

  h1{margin:0 0 14px}

  b{color:var(--ink)}

  .offer-card{background:#f9fafc;border:1px solid #e1e6ef;border-radius:10px;padding:14px;margin:10px 0}

  .offer-card strong{display:block;margin-bottom:4px}

  .offer-card small{color:#6b7a8c}

  button.accept{background:var(--accent);border:0;border-radius:8px;padding:8px 14px;color:#fff;font-weight:600;cursor:pointer;margin-top:8px}

  button.accept.accepted{background:var(--ok)}

  .hint{color:#6b7a8c;margin-top:8px}

</style>

</head>

<body>

  <div class="wrap">

    <h1>Job Details</h1>

    <div id="jobInfo" class="hint">Loading…</div>



    <h2 style="margin-top:20px;">Offers</h2>

    <div id="offersList" class="hint">No offers yet.</div>

  </div>



<script>

(async () => {

  const params = new URLSearchParams(location.search);

  const raw = (params.get('id') || '').trim();



  const SUPABASE_URL  = 'https://hczahffwghbddqabpbmu.supabase.co'; // بدّل لرابطك إن لزم

  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjemFoZmZ3Z2hiZGRxYWJwYm11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNDc1ODIsImV4cCI6MjA3NzkyMzU4Mn0.rpPNAFSKYhDRu8FTVRX2HZFHmyfpOgqflaKf3LrxPoU';



  const jobInfo = document.getElementById('jobInfo');

  const offersList = document.getElementById('offersList');



  const isUUID = s => /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s);



  if (!raw) {

    jobInfo.innerHTML = `<span style="color:red">Error: missing ?id=PBZ-12345</span>`;

    return;

  }



  // جلب بيانات المشروع

  const jobRes = await fetch(`${SUPABASE_URL}/rest/v1/homeowner_jobs?select=*&or=(id.eq.${raw},public_id.eq.${raw})`, {

    headers: { apikey: SUPABASE_ANON, Authorization:`Bearer ${SUPABASE_ANON}` }

  });

  const jobRows = await jobRes.json();

  if (!Array.isArray(jobRows) || !jobRows.length) {

    jobInfo.innerHTML = `<span style="color:red">Job not found.</span>`;

    return;

  }

  const job = jobRows[0];



  jobInfo.innerHTML = `

    <div><b>Job ID:</b> ${job.public_id}</div>

    <div><b>Title:</b> ${job.project_title}</div>

    <div><b>Name:</b> ${job.contact_name}</div>

    <div><b>Email:</b> ${job.email}</div>

    <div><b>Phone:</b> ${job.phone}</div>

    <div><b>Address:</b> ${job.full_address}</div>

    <div><b>Description:</b> ${job.full_description}</div>

  `;



  // جلب العروض

  const offersRes = await fetch(`${SUPABASE_URL}/rest/v1/pro_offers?select=*&job_id=eq.${job.id}&order=created_at.desc`, {

    headers: { apikey: SUPABASE_ANON, Authorization:`Bearer ${SUPABASE_ANON}` }

  });

  const offers = await offersRes.json();



  if (!offers.length) {

    offersList.textContent = 'No offers yet.';

    return;

  }



  offersList.innerHTML = offers.map(o => `

    <div class="offer-card" data-id="${o.id}">

      <strong>${o.pro_name} — $${o.amount || '—'}</strong>

      <div>${o.message || ''}</div>

      <small>${new Date(o.created_at).toLocaleString()}</small><br>

      ${o.status === 'accepted' 

        ? `<button class="accept accepted" disabled>✅ Accepted</button>` 

        : `<button class="accept">Accept Offer</button>`}

    </div>

  `).join('');



  // زرّ القبول

  document.querySelectorAll('button.accept:not(.accepted)').forEach(btn => {

    btn.addEventListener('click', async e => {

      const card = e.target.closest('.offer-card');

      const id = card.dataset.id;

      if (!id) return;



      btn.disabled = true;

      btn.textContent = 'Saving…';

      try {

        const res = await fetch(`${SUPABASE_URL}/rest/v1/pro_offers?id=eq.${id}`, {

          method:'PATCH',

          headers:{

            'Content-Type':'application/json',

            apikey: SUPABASE_ANON,

            Authorization:`Bearer ${SUPABASE_ANON}`,

            Prefer:'return=representation'

          },

          body: JSON.stringify({ status: 'accepted' })

        });

        if (!res.ok) throw new Error(res.status);

        btn.textContent = '✅ Accepted';

        btn.classList.add('accepted');

      } catch(err){

        btn.textContent = 'Error';

      }

    });

  });



})();

</script>

</body>

</html>
