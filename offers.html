<script>

(async () => {

  const box = document.getElementById('offersBox') || document.body;

  const params = new URLSearchParams(location.search);

  let raw = (params.get('id') || '').trim(); // نقبل id=PBZ-xxxxx أو id=UUID



  if (!raw) { box.innerHTML = `<div class="err">Missing id. Use ?id=PBZ-12345 or paste full UUID.</div>`; return; }



  const SUPABASE_URL  = 'https://hczahffwghbddqabpbmu.supabase.co';

  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjemFoZmZ3Z2hiZGRxYWJwYm11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNDc1ODIsImV4cCI6MjA3NzkyMzU4Mn0.rpPNAFSKYhDRu8FTVRX2HZFHmyfpOgqflaKf3LrxPoU';



  const isUUID = s => /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s);

  const toSuffix = code => code.toUpperCase().replace(/^PBZ-/, '').replace(/[^A-Z0-9]/g,'').slice(-5);



  let job = null;



  try {

    if (isUUID(raw)) {

      // بحث مباشر بالـ UUID

      const r = await fetch(`${SUPABASE_URL}/rest/v1/homeowner_jobs?select=*&id=eq.${encodeURIComponent(raw)}`, {

        headers: { apikey: SUPABASE_ANON, Authorization: `Bearer ${SUPABASE_ANON}` }

      });

      const rows = await r.json();

      job = rows[0] || null;

    } else {

      // بحث بالكود PBZ-xxxxx عبر مطابقة آخر 5 أحرف من uuid (بدون عمود public_id)

      const suffix = toSuffix(raw);

      if (!/^[A-Z0-9]{5}$/.test(suffix)) throw new Error('Invalid Job ID format.');

      const r = await fetch(`${SUPABASE_URL}/rest/v1/homeowner_jobs?select=*`, {

        headers: { apikey: SUPABASE_ANON, Authorization: `Bearer ${SUPABASE_ANON}` }

      });

      const rows = await r.json();

      job = (rows || []).find(x => x.id && x.id.replace(/-/g,'').toUpperCase().endsWith(suffix)) || null;

    }

  } catch (e) {

    box.innerHTML = `<div class="err">Error fetching job: ${e.message}</div>`;

    return;

  }



  if (!job) { box.innerHTML = `<div class="err">No job found for this ID.</div>`; return; }



  // عرض تفاصيل الطلب

  box.innerHTML = `

    <div class="card">

      <h2>Job Details</h2>

      <p><b>Title:</b> ${job.project_title ?? '-'}</p>

      <p><b>Name:</b> ${job.contact_name ?? job.name ?? '-'}</p>

      <p><b>Email:</b> ${job.email ?? '-'}</p>

      <p><b>Phone:</b> ${job.phone ?? '-'}</p>

      <p><b>Address:</b> ${job.full_address ?? job.address ?? '-'}</p>

      <p><b>Description:</b><br>${(job.full_description ?? job.description ?? '').replace(/\n/g,'<br>')}</p>

      <hr/>

      <h3>Offers</h3>

      <div id="offersList">Loading offers…</div>

    </div>

  `;



  // (اختياري) جلب العروض إن جهّزنا جدول pro_offers

  try {

    const ores = await fetch(`${SUPABASE_URL}/rest/v1/pro_offers?select=pro_name,amount,message,created_at&job_id=eq.${job.id}`, {

      headers: { apikey: SUPABASE_ANON, Authorization: `Bearer ${SUPABASE_ANON}` }

    });

    const offers = await ores.json();

    const list = document.getElementById('offersList');

    if (Array.isArray(offers) && offers.length) {

      list.innerHTML = offers.map(o => `

        <div class="offer">

          <div><b>${o.pro_name || 'Pro'}</b> — $${o.amount ?? '—'}</div>

          <div>${(o.message || '').replace(/\n/g,'<br>')}</div>

          <small>${new Date(o.created_at).toLocaleString()}</small>

        </div>

      `).join('');

    } else {

      list.textContent = 'No offers yet.';

    }

  } catch {

    document.getElementById('offersList').textContent = 'No offers yet.';

  }

})();

</script>
