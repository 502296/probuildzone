<script>

(async () => {

  // 1) اقرأ id من الرابط

  const params = new URLSearchParams(location.search);

  let raw = (params.get('id') || '').trim();



  const box = document.getElementById('offersBox') || document.body;



  // 2) دوال مساعدة

  const isUUID = s => /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s);

  const toPublicId = s => {

    // لو دخل 99999 نحولها PBZ-99999

    if (!s) return null;

    const u = s.toUpperCase();

    if (isUUID(u)) return null;         // هذا UUID، ليس public_id

    const digits = u.replace(/^PBZ-/, '');

    if (/^\d{5}$/.test(digits)) return `PBZ-${digits}`;

    // لو أعطى PBZ-xxxxx جاهزة نعيدها كما هي

    if (/^PBZ-\d{5}$/.test(u)) return u;

    return null;

  };



  if (!raw) {

    box.innerHTML = `<div class="err">Error: missing id in URL. Try <code>?id=PBZ-12345</code> or paste the Job ID you received.</div>`;

    return;

  }



  // 3) حضّر الاستعلام

  let url;

  const SUPABASE_URL  = '<YOUR_SUPABASE_URL>';        // مثل https://xxxx.supabase.co

  const SUPABASE_ANON = '<YOUR_SUPABASE_ANON_KEY>';   // المفتاح العام (مسموح وضعه في العميل للقراءة)



  if (isUUID(raw)) {

    // ابحث بالـUUID الحقيقي

    url = `${SUPABASE_URL}/rest/v1/homeowner_jobs?select=*&id=eq.${encodeURIComponent(raw)}`;

  } else {

    // ابحث بالـ public_id (نقبل 99999 أو PBZ-99999)

    const pid = toPublicId(raw);

    if (!pid) {

      box.innerHTML = `<div class="err">Error: invalid Job ID format. Use something like <b>PBZ-12345</b> or paste the full UUID.</div>`;

      return;

    }

    url = `${SUPABASE_URL}/rest/v1/homeowner_jobs?select=*&public_id=eq.${encodeURIComponent(pid)}`;

  }



  try {

    const res = await fetch(url, {

      headers: {

        apikey: SUPABASE_ANON,

        Authorization: `Bearer ${SUPABASE_ANON}`

      }

    });

    const rows = await res.json();



    if (!Array.isArray(rows) || rows.length === 0) {

      box.innerHTML = `<div class="err">No job found for this ID.</div>`;

      return;

    }



    const job = rows[0];



    // اعرض ملخّص الطلب (بساطة الآن)

    box.innerHTML = `

      <div class="card">

        <h2>Job Details</h2>

        <p><b>Title:</b> ${job.project_title ?? '-'}</p>

        <p><b>Name:</b> ${job.contact_name ?? job.name ?? '-'}</p>

        <p><b>Email:</b> ${job.email ?? '-'}</p>

        <p><b>Phone:</b> ${job.phone ?? '-'}</p>

        <p><b>Address:</b> ${job.full_address ?? job.address ?? '-'}</p>

        <p><b>Description:</b><br>${(job.full_description ?? job.description ?? '').replace(/\n/g,'<br>')}</p>

        <hr/>

        <h3>Offers</h3>

        <div id="offersList">Loading offers…</div>

      </div>

    `;



    // (اختياري) اجلب العروض من جدول pro_offers لو أنشأناه

    const offersUrl = `${SUPABASE_URL}/rest/v1/pro_offers?select=pro_name,amount,message,created_at&job_id=eq.${job.id}`;

    const ores = await fetch(offersUrl, {

      headers: { apikey: SUPABASE_ANON, Authorization: `Bearer ${SUPABASE_ANON}` }

    });

    const offers = await ores.json();



    const list = document.getElementById('offersList');

    if (Array.isArray(offers) && offers.length) {

      list.innerHTML = offers.map(o => `

        <div class="offer">

          <div><b>${o.pro_name || 'Pro'}</b> — $${o.amount ?? '—'}</div>

          <div>${(o.message || '').replace(/\n/g,'<br>')}</div>

          <small>${new Date(o.created_at).toLocaleString()}</small>

        </div>

      `).join('');

    } else {

      list.textContent = 'No offers yet.';

    }



  } catch (e) {

    box.innerHTML = `<div class="err">Error: ${e.message}</div>`;

  }

})();

</script>
