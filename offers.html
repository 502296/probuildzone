<!DOCTYPE html>

<html lang="en">

<head>

  <meta charset="utf-8"/>

  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <title>ProBuildZone — Offers</title>

  <link rel="stylesheet" href="style.css"/>

  <style>

    body{background:#f6f7fb;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,sans-serif;color:#0f2a43;}

    .wrap{max-width:980px;margin:32px auto;padding:0 16px;}

    .card{background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:20px;}

    .err{margin:16px auto;max-width:860px;background:#fff3f3;color:#b00020;border:1px solid #f8c6c6;border-radius:8px;padding:12px 16px;}

    .offer{border:1px solid #e7edf5;border-radius:10px;padding:12px;margin:10px 0;background:#fff;}

  </style>

</head>

<body>

  <div class="wrap">

    <div id="offersBox" class="card">Loading…</div>

  </div>



  <script>

  (async () => {

    const params = new URLSearchParams(location.search);

    let raw = (params.get('id') || '').trim();

    const box = document.getElementById('offersBox');



    const isUUID = s => /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s);

    const toPublicId = s => {

      if (!s) return null;

      const u = s.toUpperCase();

      if (isUUID(u)) return null;

      const digits = u.replace(/^PBZ-/, '');

      if (/^\d{5}$/.test(digits)) return `PBZ-${digits}`;

      if (/^PBZ-\d{5}$/.test(u)) return u;

      return null;

    };



    if (!raw) { box.innerHTML = `<div class="err">Error: missing id in URL. Try <b>?id=PBZ-12345</b> or paste the full UUID.</div>`; return; }



    const SUPABASE_URL  = 'https://hczahffwghbddqabpbmu.supabase.co';

    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhjemFoZmZ3Z2hiZGRxYWJwYm11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNDc1ODIsImV4cCI6MjA3NzkyMzU4Mn0.rpPNAFSKYhDRu8FTVRX2HZFHmyfpOgqflaKf3LrxPoU';



    let url;

    if (isUUID(raw)) {

      url = `${SUPABASE_URL}/rest/v1/homeowner_jobs?select=*&id=eq.${encodeURIComponent(raw)}`;

    } else {

      const pid = toPublicId(raw);

      if (!pid) { box.innerHTML = `<div class="err">Error: invalid Job ID format. Use <b>PBZ-12345</b> or paste UUID.</div>`; return; }

      url = `${SUPABASE_URL}/rest/v1/homeowner_jobs?select=*&public_id=eq.${encodeURIComponent(pid)}`;

    }



    try {

      const res = await fetch(url,{ headers:{ apikey: SUPABASE_ANON, Authorization:`Bearer ${SUPABASE_ANON}` }});

      const rows = await res.json();

      if (!Array.isArray(rows) || rows.length === 0) { box.innerHTML = `<div class="err">No job found for this ID.</div>`; return; }

      const job = rows[0];



      box.innerHTML = `

        <div>

          <h2 style="margin:0 0 10px">Job Details</h2>

          <p><b>Job ID:</b> ${job.public_id || job.id}</p>

          <p><b>Title:</b> ${job.title ?? '-'}</p>

          <p><b>Name:</b> ${job.name ?? '-'}</p>

          <p><b>Email:</b> ${job.email ?? '-'}</p>

          <p><b>Phone:</b> ${job.phone ?? '-'}</p>

          <p><b>Address:</b> ${job.address ?? '-'}</p>

          <p><b>Description:</b><br>${(job.description ?? '').replace(/\n/g,'<br>')}</p>

          <hr/>

          <h3>Offers</h3>

          <div id="offersList">Loading offers…</div>

        </div>

      `;



      const offersUrl = `${SUPABASE_URL}/rest/v1/pro_offers?select=pro_name,amount,message,created_at&job_id=eq.${job.id}`;

      const ores = await fetch(offersUrl, { headers:{ apikey: SUPABASE_ANON, Authorization:`Bearer ${SUPABASE_ANON}` }});

      const offers = await ores.json();



      const list = document.getElementById('offersList');

      if (Array.isArray(offers) && offers.length) {

        list.innerHTML = offers.map(o => `

          <div class="offer">

            <div><b>${o.pro_name || 'Pro'}</b> — $${o.amount ?? '—'}</div>

            <div>${(o.message || '').replace(/\n/g,'<br>')}</div>

            <small>${new Date(o.created_at).toLocaleString()}</small>

          </div>

        `).join('');

      } else {

        list.textContent = 'No offers yet.';

      }

    } catch (e) {

      box.innerHTML = `<div class="err">Error: ${e.message}</div>`;

    }

  })();

  </script>

</body>

</html>
