<!doctype html>

<html lang="en">

<head>

  <meta charset="utf-8"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <title>ProBuildZone — Submit Offer</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>

    :root{

      --ink:#0F2A43; --muted:#6b7a8c; --bg:#f5f7fb; --card:#fff;

      --shadow:0 10px 24px rgba(15,42,67,.06); --radius:16px; --blue:#0d5bd7;

    }

    *{box-sizing:border-box}

    body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink)}

    .wrap{max-width:720px;margin:40px auto;padding:0 16px}

    .card{background:var(--card);box-shadow:var(--shadow);border-radius:var(--radius);padding:24px}

    h1{margin:0 0 16px;font-size:36px}

    label{display:block;font-weight:700;margin:12px 0 6px}

    input,textarea{

      width:100%;padding:14px 12px;border-radius:12px;border:1px solid #dee6f1;background:#fbfdff;font-size:16px

    }

    textarea{min-height:120px;resize:vertical}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

    .btn{margin-top:16px;display:inline-block;background:var(--blue);color:#fff;font-weight:800;border:none;border-radius:12px;padding:14px 18px;cursor:pointer}

    .muted{color:var(--muted)}

    .ok{color:#0a7f3f;font-weight:700;margin-top:10px}

    .err{color:#b00020;font-weight:700;margin-top:10px}

    .pill{display:inline-block;padding:4px 10px;border:1px solid #e0e6ef;border-radius:999px;margin-left:8px}

  </style>

</head>

<body>

  <div class="wrap">

    <div class="card">

      <h1>Submit Offer <span id="jobIdPill" class="pill"></span></h1>



      <div id="jobMini" class="muted" style="margin:-6px 0 14px"></div>



      <form id="offerForm">

        <label>Your business name *</label>

        <input id="pro_name" required placeholder="e.g., Bluegrass Roofing"/>



        <div class="row">

          <div>

            <label>Offer amount (USD)</label>

            <input id="amount" inputmode="decimal" placeholder="e.g., 1250"/>

          </div>

          <div>

            <label>Phone (optional)</label>

            <input id="phone" placeholder="optional"/>

          </div>

        </div>



        <label>Message to homeowner</label>

        <textarea id="message" placeholder="Hello Ali, I can start next week. Includes materials & cleanup..."></textarea>



        <button class="btn" type="submit">Send Offer</button>

        <div id="status" class="muted"></div>

      </form>

    </div>

  </div>



  <script type="module">

    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';



    // ====== Supabase (ضع نفس القيم الموجودة في job.html) ======

    const SUPABASE_URL  = 'https://hczahffwghbddqabpbmu.supabase.co';

    const SUPABASE_ANON = 'PUT_YOUR_ANON_KEY_HERE';

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON);



    // ====== Query string ======

    const params   = new URLSearchParams(location.search);

    const PUBLIC_ID = (params.get('id') || '').trim();

    const jobPill  = document.getElementById('jobIdPill');

    const jobMini  = document.getElementById('jobMini');

    const form     = document.getElementById('offerForm');

    const statusEl = document.getElementById('status');



    if(!PUBLIC_ID){

      jobMini.textContent = 'Missing job id in URL.';

    }else{

      jobPill.textContent = PUBLIC_ID;

      loadJobMini();

    }



    async function loadJobMini(){

      const { data: job, error } = await sb

        .from('homeowner_jobs')

        .select('id, title')

        .eq('public_id', PUBLIC_ID)

        .maybeSingle();



      if(error){ jobMini.textContent = 'Error loading job.'; return; }

      if(!job){ jobMini.textContent = 'Job not found.'; return; }



      // keep job.id for insert

      form.dataset.jobUuid = job.id;

      jobMini.textContent  = `Job: ${job.title}`;

    }



    form.addEventListener('submit', async (e)=>{

      e.preventDefault();

      statusEl.className = 'muted';

      statusEl.textContent = 'Sending...';



      const job_id  = form.dataset.jobUuid; // UUID from homeowner_jobs

      if(!job_id){ statusEl.className='err'; statusEl.textContent='Job not found.'; return; }



      const pro_name = document.getElementById('pro_name').value.trim();

      const phone    = document.getElementById('phone').value.trim() || null;

      const message  = document.getElementById('message').value.trim() || null;



      // amount: allow empty → null, else parse to number

      const amountRaw = document.getElementById('amount').value.trim();

      const amount = amountRaw === '' ? null : Number(amountRaw);



      const { error } = await sb.from('job_offers').insert([{

        job_id, pro_name, amount, phone, message, status: 'sent'

      }]);



      if(error){

        statusEl.className='err';

        statusEl.textContent = 'Error: unable to send offer.';

        console.error(error);

        return;

      }



      statusEl.className='ok';

      statusEl.textContent = '✅ Offer sent!';

      // optional: back to job page

      setTimeout(()=>location.href=`/job.html?id=${encodeURIComponent(PUBLIC_ID)}`, 700);

    });

  </script>

</body>

</html>
