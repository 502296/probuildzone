<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<script>

  // 1) غيّر هذول على مشروعك

  const SUPABASE_URL = 'https://YOUR-PROJECT-REF.supabase.co';

  const SUPABASE_KEY = 'YOUR-ANON-KEY';

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);



  // 2) نجيب العناصر من الصفحة الموجودة فعلاً

  const fileInput     = document.querySelector('input[type="file"]'); // اللي فوق

  const titleInput    = document.querySelector('input[placeholder^="e.g.,"]');

  const summaryInput  = document.querySelector('input[placeholder^="One or two"]');

  const cityInput     = document.querySelector('input[placeholder="Enter your city"]');

  const stateInput    = document.querySelector('input[placeholder="Enter your state"]');

  const budgetFromInp = document.querySelector('input[placeholder="From ($)"]');

  const budgetToInp   = document.querySelector('input[placeholder="To ($)"]');

  const contactInput  = document.querySelector('input[placeholder="Your name"]');

  const phoneInput    = document.querySelector('input[placeholder="Your phone number"]');

  const emailInput    = document.querySelector('input[placeholder="Your email address"]');

  const addressInput  = document.querySelector('input[placeholder="Street, City, State"]');

  const descTextarea  = document.querySelector('textarea'); // عندك واحدة فقط

  // زر الإرسال

  const postBtn       = document.querySelector('button, .btn, .post-btn, [type="button"]')

                           .closest('button') || document.querySelector('button');



  // نضيف مكان للرسالة لو ما كان موجود

  let msgBar = document.getElementById('ho-msg');

  if (!msgBar) {

    msgBar = document.createElement('div');

    msgBar.id = 'ho-msg';

    msgBar.style.marginTop = '14px';

    msgBar.style.fontSize = '14px';

    msgBar.style.fontWeight = '500';

    msgBar.style.color = '#fff';

    postBtn.parentNode.appendChild(msgBar);

  }



  function showMsg(text, isError = false) {

    msgBar.textContent = text;

    msgBar.style.color = isError ? '#ffb4b4' : '#b4ffcb';

  }



  // 3) رفع الصور إلى bucket اسمه homeowner_uploads

  async function uploadFilesToSupabase(files) {

    const bucket = 'homeowner_uploads';

    const urls = [];



    for (const file of files) {

      const ext = file.name.split('.').pop();

      const fileName = `job-${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;



      const { data, error } = await supabase

        .storage

        .from(bucket)

        .upload(fileName, file);



      if (error) {

        console.warn('upload error:', error.message);

        continue; // نكمّل على الباقي

      }



      const { data: publicData } = supabase

        .storage

        .from(bucket)

        .getPublicUrl(fileName);



      if (publicData && publicData.publicUrl) {

        urls.push(publicData.publicUrl);

      }

    }



    return urls;

  }



  // 4) الحدث

  postBtn.addEventListener('click', async () => {

    showMsg('', false);



    // جمع البيانات

    const payload = {

      category: 'General',

      title: titleInput?.value.trim() || '',

      summary: summaryInput?.value.trim() || '',

      city: cityInput?.value.trim() || '',

      state: stateInput?.value.trim() || '',

      zip: '', // ما عندك حقل ظاهر بالواجهة

      budget_from: budgetFromInp?.value.trim() || '',

      budget_to: budgetToInp?.value.trim() || '',

      contact_name: contactInput?.value.trim() || '',

      phone: phoneInput?.value.trim() || '',

      email: emailInput?.value.trim() || '',

      full_address: addressInput?.value.trim() || '',

      description: descTextarea?.value.trim() || '',

    };



    // تحقق بسيط مثل اللي كان عندك

    if (!payload.title || !payload.contact_name || !payload.phone || !payload.email) {

      showMsg('Please fill title, contact name, phone and email.', true);

      return;

    }



    // تعطيل الزر

    const originalText = postBtn.textContent;

    postBtn.disabled = true;

    postBtn.textContent = 'Posting...';



    try {

      // أولاً: رفع الصور لو فيه

      let photo_urls = [];

      if (fileInput && fileInput.files && fileInput.files.length > 0) {

        photo_urls = await uploadFilesToSupabase(fileInput.files);

      }



      // ثانياً: إدخال الصف في homeowner_jobs

      const { data, error } = await supabase

        .from('homeowner_jobs')

        .insert([{

          category: payload.category,

          title: payload.title,

          summary: payload.summary,

          city: payload.city,

          state: payload.state,

          zip: payload.zip,

          budget_from: payload.budget_from,

          budget_to: payload.budget_to,

          contact_name: payload.contact_name,

          phone: payload.phone,

          email: payload.email,

          full_address: payload.full_address,

          description: payload.description,

          photo_urls: photo_urls.length ? photo_urls : null

        }])

        .select()

        .single();



      if (error) {

        console.error(error);

        showMsg('DB error: ' + error.message, true);

      } else {

        showMsg('Job posted successfully!');

      }



    } catch (err) {

      console.error(err);

      showMsg('Unexpected error: ' + err.message, true);

    } finally {

      postBtn.disabled = false;

      postBtn.textContent = originalText;

    }

  });

</script>
