<!doctype html>

<html lang="en" dir="ltr">

<head>

  <meta charset="utf-8"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <title>Job Details — ProBuildZone</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>

    :root{

      --ink:#0F2A43;

      --ink-2:#0b2033;

      --muted:#6b7a8c;

      --ok:#0a7d2a;

      --err:#b00020;

      --bg:#f6f7fb;

      --card:#ffffff;

      --border:#e7ecf3;

      --blue:#0f62fe;

      --blue-700:#0c4ed6;

      --radius:16px;

    }

    *{box-sizing:border-box}

    html,body{

      margin:0;

      padding:0;

      background:var(--bg);

      font-family:Inter,system-ui,Arial,sans-serif;

      color:var(--ink);

    }

    .wrap{max-width:980px;margin:28px auto;padding:0 16px}

    .card{

      background:var(--card);

      border:1px solid var(--border);

      border-radius:24px;

      padding:22px 20px;

      box-shadow:0 10px 24px rgba(15,42,67,0.06);

    }

    h1{

      margin:0 0 18px;

      font-size:40px;

      letter-spacing:-0.5px;

    }

    .grid{

      display:grid;

      grid-template-columns:1fr 2fr;

      gap:8px 16px;

    }

    .k{color:var(--muted);font-weight:600}

    .v a{color:#0a58ca;text-decoration:none}

    .btns{

      display:flex;

      gap:12px;

      margin-top:18px;

      flex-wrap:wrap;

    }

    .btn{

      appearance:none;

      border:none;

      cursor:pointer;

      padding:12px 18px;

      border-radius:12px;

      font-weight:700;

    }

    .btn.primary{background:var(--blue);color:#fff}

    .btn.primary:active{transform:translateY(1px)}

    .btn.primary:hover{background:var(--blue-700)}

    .btn.white{

      background:#fff;

      border:1px solid var(--border);

      color:var(--ink);

    }

    h2{margin:26px 0 12px}

    .muted{color:var(--muted)}

    .error{color:var(--err)}

    .offer-card{

      background:#fff;

      border:1px solid var(--border);

      border-radius:12px;

      padding:14px 16px;

      margin-top:12px;

    }

    .badge{

      font-size:12px;

      padding:2px 8px;

      border-radius:10px;

      background:#eef4ff;

      margin-left:6px;

    }

    @media (max-width:640px){

      h1{font-size:34px}

      .grid{grid-template-columns:1fr}

    }

  </style>

</head>

<body>

  <div class="wrap">

    <div class="card">

      <h1>Job Details</h1>



      <div id="jobError" class="error" style="margin-bottom:8px"></div>



      <div id="jobBox" class="grid" style="display:none">

        <div class="k">Job ID:</div>      <div class="v" id="v_id"></div>

        <div class="k">Title:</div>       <div class="v" id="v_title"></div>

        <div class="k">Name:</div>        <div class="v" id="v_name"></div>

        <div class="k">Email:</div>       <div class="v" id="v_email"></div>

        <div class="k">Phone:</div>       <div class="v" id="v_phone"></div>

        <div class="k">Address:</div>     <div class="v" id="v_address"></div>

        <div class="k">Description:</div> <div class="v" id="v_summary"></div>

      </div>



      <div class="btns">

        <a id="offerLink" class="btn primary" href="#">Submit Offer</a>

        <a class="btn white" href="/index.html">Back to Home</a>

      </div>



      <h2>Offers</h2>

      <div id="offersBox" class="muted">Loading...</div>

      <p id="offersError" class="error"></p>

    </div>

  </div>



  <script>

    (async () => {

      const params = new URLSearchParams(location.search);

      const publicId = params.get('id');



      const jobBox    = document.getElementById('jobBox');

      const jobError  = document.getElementById('jobError');

      const v_id      = document.getElementById('v_id');

      const v_title   = document.getElementById('v_title');

      const v_name    = document.getElementById('v_name');

      const v_email   = document.getElementById('v_email');

      const v_phone   = document.getElementById('v_phone');

      const v_address = document.getElementById('v_address');

      const v_summary = document.getElementById('v_summary');



      const offerLink  = document.getElementById('offerLink');

      const offersBox  = document.getElementById('offersBox');

      const offersError = document.getElementById('offersError');



      if (!publicId) {

        jobError.textContent = "Job not found.";

        offersBox.textContent = "Couldn't load offers.";

        return;

      }



      // link to pro offer page

      offerLink.href = `/pro-offer.html?id=${encodeURIComponent(publicId)}`;



      try {

        // 1) get job details from Netlify function

        const jobRes  = await fetch(`/.netlify/functions/get-job?id=${encodeURIComponent(publicId)}`);

        const jobJson = await jobRes.json();



        if (!jobRes.ok || !jobJson.ok || !jobJson.job) {

          jobError.textContent = jobJson.error || "Job not found.";

          offersBox.textContent = "No offers yet.";

          return;

        }



        const j = jobJson.job;



        jobBox.style.display = "";



        v_id.textContent    = j.public_id || publicId;

        v_title.textContent = j.title || j.project_title || j.category || "—";

        v_name.textContent  = j.name || j.full_name || "—";



        const email = j.email;

        const phone = j.phone;



        v_email.innerHTML = email ? `<a href="mailto:${email}">${email}</a>` : "—";

        v_phone.innerHTML = phone ? `<a href="tel:${phone}">${phone}</a>`   : "—";



        const addr =

          j.address ||

          j.full_address ||

          [j.city, j.state, j.zip].filter(Boolean).join(", ");



        v_address.textContent = addr || "—";



        const summary = j.summary || j.short_summary || j.full_description;

        v_summary.textContent = summary || "—";



        // 2) get offers (نترك نفس مسار /api إذا كان شغال عندك)

        const offRes  = await fetch(`/api/get-offers?id=${encodeURIComponent(publicId)}`);

        const offJson = await offRes.json();



        offersBox.innerHTML = "";

        if (!offRes.ok) {

          offersError.textContent = offJson.error || "Couldn't load offers.";

          return;

        }



        if (!offJson.offers || offJson.offers.length === 0) {

          offersBox.innerHTML = `<p class="muted" style="margin:0">No offers yet.</p>`;

          return;

        }



        offJson.offers.forEach(o => {

          const amount = (o.amount != null) ? `$${Number(o.amount).toLocaleString()}` : "$—";

          const phoneLine = o.phone ? ` • ${o.phone}` : "";

          const statusBadge = `<span class="badge">${o.status}</span>`;



          const div = document.createElement('div');

          div.className = 'offer-card';

          div.innerHTML = `

            <div style="font-weight:700;margin-bottom:4px">

              ${o.business_name} — ${amount} ${statusBadge}

            </div>

            <div style="color:#334155;white-space:pre-wrap">${o.message || ""}</div>

            <div style="color:#6b7a8c;margin-top:6px">

              ${new Date(o.created_at).toLocaleString()}${phoneLine}

            </div>

            <div style="margin-top:10px">

              <button data-id="${o.id}" class="accept-btn btn primary" style="padding:8px 12px">

                Accept

              </button>

            </div>

          `;

          offersBox.appendChild(div);

        });



        // 3) accept offer handler

        offersBox.addEventListener('click', async (e) => {

          const btn = e.target.closest('.accept-btn');

          if (!btn) return;



          btn.disabled = true;

          try {

            const offerId = btn.getAttribute('data-id');

            const res = await fetch('/api/accept-offer', {

              method: 'POST',

              headers: { 'Content-Type': 'application/json' },

              body: JSON.stringify({ offer_id: offerId }),

            });



            if (res.ok) {

              location.reload();

            } else {

              const errText = await res.text();

              alert('Failed to accept offer: ' + errText);

              btn.disabled = false;

            }

          } catch (err) {

            console.error(err);

            alert('Failed to accept offer.');

            btn.disabled = false;

          }

        });

      } catch (err) {

        console.error(err);

        jobError.textContent   = "Job not found.";

        offersError.textContent = "Couldn't load offers.";

      }

    })();

  </script>

</body>

</html>
